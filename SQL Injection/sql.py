#!/bin/python3


import sqlite3
from flask import Flask, render_template, request, url_for, flash, redirect
from sqlite3 import Error
import hashlib

def createConnection(path):
    connection = None
    try:
        connection = sqlite3.connect(path, check_same_thread=False)
        print("Connection to SQLite DB successful")
    except Error as e:
        print(f"The error '{e}' occurred")
    return connection

def runQuery(conn, query):
    post = conn.execute(query)
    if post is None:
        abort(404)
    return post

connection = createConnection("db.sqlite")
app = Flask(__name__)


@app.route('/', methods=('GET', 'POST'))
def index():
    debugInfo = "VALUABLE DEBUG INFO:  Your name is Dan, and your ID is 1334222f-51e8-4c86-aca7-8ee3f685dde7"
    if request.method == 'POST':
        ID = request.form['ID']
        if not ID:
            return render_template('index.html', debugInfo = debugInfo)
        else:
            return redirect("/"+ID)
    else:
        return render_template('index.html', debugInfo = debugInfo)

@app.route('/<string:theID>', methods=('GET', 'POST'))
def helloUser(theID):
    if request.method == 'POST':
        ID = request.form['ID']
        if ID:
            return redirect("/"+ID)

    sqlQuery = 'SELECT * FROM users WHERE ID = "' + theID + '";'
    result = runQuery(connection, sqlQuery).fetchall()

    debugInfo = "VALUABLE DEBUG INFO:  Your name is Dan, and your ID is 1334222f-51e8-4c86-aca7-8ee3f685dde7" 
    return render_template('userpage.html', users=result, debugInfo = debugInfo, sqlQuery = sqlQuery)

@app.route('/changePassword', methods=('GET', 'POST'))
def changePW():
    debugInfo = "VALUABLE DEBUG INFO:  Your name is Dan, and your ID is 1334222f-51e8-4c86-aca7-8ee3f685dde7" 

    if request.method == 'POST':
        ID = request.form['ID']
        newPass = request.form['newPass']
        
        if ID:
            if newPass:
                sqlQuery = 'UPDATE users SET password = "' + newPass + '" WHERE id = "' + ID + '";'
                try:
                    result = runQuery(connection, sqlQuery).fetchall()
                    aMessage = "Successfully Changed Password"
                except:
                    aMessage = "SQL error"
                return render_template('changePassword.html', aMessage = aMessage,debugInfo = debugInfo, sqlQuery = sqlQuery)
    else:
        debugInfo = "VALUABLE DEBUG INFO:  Your name is Dan, and your ID is 1334222f-51e8-4c86-aca7-8ee3f685dde7" 
        return render_template('changePassword.html', debugInfo = debugInfo, sqlQuery = "")



